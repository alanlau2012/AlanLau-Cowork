---
name: 设置界面重构实施
overview: 基于高保真原型，重构设置界面：删除API配置项，优化工作目录和诊断功能的UI呈现
todos:
  - id: html-refactor
    content: 重构HTML：删除API端点/密钥/模型字段，改为卡片式布局
    status: completed
  - id: css-refactor
    content: 重构CSS：删除旧样式，添加卡片式样式系统（参考原型）
    status: completed
  - id: js-cleanup
    content: 清理JavaScript：删除API/模型相关代码，优化诊断渲染逻辑
    status: completed
  - id: diagnosis-ui
    content: 优化诊断UI：改为卡片式展示，每个检查项独立卡片
    status: completed
  - id: workspace-ui
    content: 优化工作目录UI：独立卡片式布局，现代化toggle开关
    status: completed
  - id: main-process
    content: 调整主进程：更新默认设置结构，确保向后兼容
    status: completed
---

# 设置界面重构实施计划

## 目标

按照 `ux-prototype/settings-redesign.html` 的高保真原型，重构实际应用的设置界面。

## 文件修改清单

### 1. HTML结构重构 (`renderer/index.html`)

**删除内容（第317-358行）：**

- API端点输入框（第318-322行）
- API密钥输入框（第324-332行）
- 可用模型列表（第351-358行）

**重构内容：**

- 工作目录部分：改为卡片式布局（参考原型第334-349行）
- 诊断部分：改为卡片式布局（参考原型第360-365行）

**新的HTML结构：**

```html
<!-- 工作目录设置卡片 -->
<div class="settings-card">
  <div class="settings-card-header">
    <h3>
      <span>工作目录</span>
      <span class="card-badge">文件操作范围</span>
    </h3>
  </div>
  <div class="settings-card-body">
    <div class="workspace-input-wrapper">
      <input type="text" id="workspaceDir" placeholder="D:\Projects\my-workspace" />
      <button type="button" id="browseWorkspaceBtn" class="browse-btn" title="浏览选择目录">
        📁
      </button>
    </div>
    <p class="input-hint">Agent 的文件操作将被限制在此目录内，确保系统安全</p>
    <div class="sandbox-toggle-wrapper">
      <label class="sandbox-toggle-label">
        <div>
          <div class="sandbox-toggle-label-text">启用文件沙箱保护</div>
          <div class="sandbox-toggle-label-desc">限制文件操作在指定目录内，防止误操作</div>
        </div>
        <div style="display: flex; align-items: center;">
          <label class="toggle-switch">
            <input type="checkbox" id="sandboxEnabled" />
            <span class="toggle-slider"></span>
          </label>
          <span class="sandbox-status active" id="sandboxStatus">已启用</span>
        </div>
      </label>
    </div>
  </div>
</div>

<!-- 系统诊断卡片 -->
<div class="settings-card">
  <div class="settings-card-header">
    <h3>系统诊断</h3>
    <button type="button" id="diagnoseBtn" class="diagnose-btn">运行诊断</button>
  </div>
  <div class="settings-card-body">
    <div id="diagnoseResult" class="diagnose-cards hidden">
      <!-- 诊断结果将动态渲染 -->
    </div>
    <p class="input-hint" style="margin-top: 0;">检查系统连接状态和配置是否正确</p>
  </div>
</div>
```

### 2. CSS样式重构 (`renderer/style.css`)

**删除样式：**

- `.password-input-wrapper` 相关样式（第2125-2156行）
- `.models-list`、`.model-item` 相关样式（第2243-2353行）
- 旧的 `.sandbox-toggle` 样式（第2190-2207行）

**新增样式（参考原型）：**

- `.settings-card`：卡片容器样式
- `.settings-card-header`：卡片头部样式
- `.settings-card-body`：卡片主体样式
- `.card-badge`：徽章样式
- `.workspace-input-wrapper`：优化后的目录输入布局
- `.sandbox-toggle-wrapper`：新的沙箱开关容器
- `.sandbox-toggle-label`：开关标签样式
- `.toggle-switch`：现代化toggle开关样式
- `.toggle-slider`：开关滑块样式
- `.diagnose-cards`：诊断卡片容器
- `.diagnose-card`：单个诊断卡片样式（支持success/warning/error/loading状态）
- `.diagnose-icon`：诊断图标样式
- `.diagnose-content`：诊断内容容器
- `.diagnose-title`：诊断标题
- `.diagnose-status`：诊断状态文本
- `.diagnose-btn`：诊断按钮样式

**关键样式要点：**

- 卡片圆角：12px
- 卡片间距：20px
- 卡片内边距：20px
- Toggle开关：48px宽，26px高，使用CSS实现动画
- 诊断卡片：支持4种状态（success/warning/error/loading）

### 3. JavaScript逻辑调整 (`renderer/renderer.js`)

**删除代码：**

- `settings` 对象中的 `apiEndpoint`、`apiKey`、`models` 字段（第1800-1805行）
- `apiEndpointInput`、`apiKeyInput`、`toggleApiKeyBtn`、`modelsList`、`addModelBtn` 变量声明（第1814-1818行）
- `openSettingsModal()` 中填充API端点和密钥的代码（第1847-1852行）
- `renderModelsList()` 函数（第1912-1935行）
- `addModel()` 函数（第1937-1954行）
- `removeModel()` 函数（第1956-1973行）
- `saveSettings()` 中保存API端点和密钥的代码（第1978-1979行）
- `saveSettings()` 中更新模型的代码（第1981-2002行）
- `updateModelSelectors()` 函数（第2135-2169行）

**优化代码：**

- `runDiagnosis()` 函数（第2091-2133行）：改为生成卡片式诊断结果

  ```javascript
  // 新的诊断结果渲染逻辑
  diagnoseResult.innerHTML = `
    <div class="diagnose-card success">
      <div class="diagnose-icon">✓</div>
      <div class="diagnose-content">
        <div class="diagnose-title">后端服务器</div>
        <div class="diagnose-status">正常</div>
      </div>
    </div>
    <!-- 更多诊断卡片 -->
  `;
  ```

- `updateSandboxStatus()` 函数（第1882-1901行）：保持逻辑，但确保与新的HTML结构兼容

- `openSettingsModal()` 函数：删除API相关代码，保留工作目录加载

- `saveSettings()` 函数：删除API和模型相关代码，只保留工作目录保存

**新增功能：**

- 确保toggle开关的change事件正确绑定
- 确保诊断按钮的点击事件正确绑定

### 4. 主进程设置处理 (`main.js`)

**调整内容：**

- `DEFAULT_SETTINGS` 对象（第89-96行）：删除 `apiEndpoint`、`apiKey`、`models` 字段
- 确保向后兼容：如果旧设置文件包含这些字段，忽略它们

## 实施步骤

1. **HTML重构**：删除不需要的字段，重构为卡片式布局
2. **CSS重构**：删除旧样式，添加新卡片样式系统
3. **JavaScript清理**：删除相关变量和函数
4. **诊断功能优化**：改为卡片式渲染
5. **主进程调整**：更新默认设置结构
6. **测试验证**：确保所有功能正常

## 设计规范（参考原型）

### 卡片式布局

- 每个功能模块独立卡片
- 卡片圆角：12px
- 卡片间距：20px
- 卡片内边距：20px
- 卡片阴影：hover时显示轻微阴影

### 诊断卡片设计

- 每个检查项独立卡片
- 左侧图标（✓/⚠/✗），右侧内容
- 状态颜色：成功（绿色）、警告（黄色）、错误（红色）
- 卡片背景：根据状态有轻微背景色
- 加载状态：显示旋转动画

### 工作目录卡片

- 顶部标题 + 徽章说明
- 目录输入框 + 浏览按钮
- 沙箱保护开关：现代化toggle样式（48x26px）
- 状态指示：实时显示沙箱状态（已启用/已禁用/未配置目录）

## 注意事项

1. 保持与应用现有设计系统的一致性（颜色、字体、间距）
2. 确保所有交互功能正常工作（toggle开关、诊断按钮、浏览按钮）
3. 保持响应式设计，适配不同屏幕尺寸
4. 确保向后兼容，旧设置文件可以正常加载
5. 诊断功能需要与实际后端API集成，保持现有逻辑
