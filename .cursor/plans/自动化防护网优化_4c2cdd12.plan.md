---
name: è‡ªåŠ¨åŒ–é˜²æŠ¤ç½‘ä¼˜åŒ–
overview: é’ˆå¯¹å³å°†å¢åŠ çš„ç³»ç»Ÿè®¾ç½®å’Œæ²™ç®±åŠŸèƒ½ï¼Œå…¨é¢åŠ å›ºé¡¹ç›®çš„è‡ªåŠ¨åŒ–æµ‹è¯•é˜²æŠ¤ç½‘ï¼Œè¦†ç›–å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2Eæµ‹è¯•ã€CI/CDã€ä»£ç è´¨é‡æ£€æŸ¥ç­‰å…³é”®ç¯èŠ‚ã€‚
todos:
  - id: eslint-setup
    content: æ·»åŠ  ESLint + Prettier + Husky ä»£ç è´¨é‡æ£€æŸ¥
    status: completed
  - id: coverage-threshold
    content: é…ç½® Vitest è¦†ç›–ç‡é˜ˆå€¼å¹¶ç”ŸæˆæŠ¥å‘Š
    status: completed
  - id: renderer-refactor
    content: é‡æ„ renderer.jsï¼Œæå–å¯æµ‹è¯•é€»è¾‘åˆ°ç‹¬ç«‹æ¨¡å—
    status: pending
  - id: preload-test
    content: æ·»åŠ  preload.js å•å…ƒæµ‹è¯•
    status: completed
  - id: settings-test-scaffold
    content: åˆ›å»ºç³»ç»Ÿè®¾ç½®åŠŸèƒ½æµ‹è¯•è„šæ‰‹æ¶
    status: completed
  - id: sandbox-test-scaffold
    content: åˆ›å»ºæ²™ç®±åŠŸèƒ½å®‰å…¨æµ‹è¯•è„šæ‰‹æ¶
    status: pending
  - id: contract-schema
    content: å®šä¹‰ API å¥‘çº¦ JSON Schema
    status: completed
---

# è‡ªåŠ¨åŒ–æµ‹è¯•é˜²æŠ¤ç½‘ä¼˜åŒ–è®¡åˆ’

## å½“å‰çŠ¶æ€è¯„ä¼°

### å·²æœ‰èƒ½åŠ› (Good)

- **æµ‹è¯•æ¡†æ¶**ï¼šVitest + Playwright åŒå¼•æ“æ¶æ„
- **å•å…ƒæµ‹è¯•**ï¼š`utils.test.js` è¦†ç›– 10 ä¸ªå·¥å…·å‡½æ•°ï¼Œå…± 363 è¡Œæµ‹è¯•ä»£ç 
- **API æµ‹è¯•**ï¼š`server.test.js` è¦†ç›–å¥åº·æ£€æŸ¥ã€SSE å“åº”æ ¼å¼ã€è¯·æ±‚éªŒè¯ï¼Œå…± 261 è¡Œ
- **E2E æµ‹è¯•**ï¼š3 ä¸ªè§„èŒƒæ–‡ä»¶è¦†ç›–åº”ç”¨å¯åŠ¨ã€èŠå¤©æµç¨‹ã€æ—¶é—´çº¿/Tab åŠŸèƒ½

### å…³é”®ç¼ºå£ (Gaps)

| ç¼ºå£ç±»å‹ | é£é™©ç­‰çº§ | çŠ¶æ€ | æè¿° |

|---------|---------|------|------|

| æ¸²æŸ“å±‚æµ‹è¯•ä¸è¶³ | P0 | âš ï¸ å¾…å®Œæˆ | `renderer.js` 1459 è¡Œï¼Œä»…å·¥å…·å‡½æ•°è¢«æµ‹è¯• |

| è¦†ç›–ç‡æ— é—¨æ§› | P1 | âœ… å·²è§£å†³ | å·²é…ç½®é˜ˆå€¼ï¼š60% statements, 50% branches |

| ä»£ç è´¨é‡æ£€æŸ¥ç¼ºå¤± | P1 | âœ… å·²è§£å†³ | ESLint + Prettier + Husky å·²é…ç½® |

| å¥‘çº¦æµ‹è¯•ç¼ºå¤± | P1 | âœ… å·²è§£å†³ | API Schema å·²å®šä¹‰ï¼ˆapi-chat-request, sse-eventsï¼‰ |

| å®‰å…¨æµ‹è¯•ç¼ºå¤± | P2 | âš ï¸ å¾…å®Œæˆ | æ²™ç®±åŠŸèƒ½éœ€è¦å®‰å…¨è¾¹ç•Œæµ‹è¯• |

---

## é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½åŠ å›º (P0)

### 1.1 ä»£ç è´¨é‡é—¨ç¦

æ·»åŠ  ESLint + Prettier é…ç½®ï¼Œå¹¶é›†æˆ pre-commit hooksï¼š

- å®‰è£…ä¾èµ–ï¼š`eslint`, `prettier`, `husky`, `lint-staged`
- é…ç½® `.eslintrc.js` å¯ç”¨ ES modules è§„åˆ™
- é…ç½® `.prettierrc` ç»Ÿä¸€ä»£ç é£æ ¼
- é…ç½® `husky` + `lint-staged` å®ç°æäº¤å‰æ£€æŸ¥

### 1.2 è¦†ç›–ç‡é—¨æ§›

æ›´æ–° [vitest.config.js](vitest.config.js) æ·»åŠ è¦†ç›–ç‡é˜ˆå€¼ï¼š

```javascript
coverage: {
  provider: 'v8',
  thresholds: {
    statements: 60,
    branches: 50,
    functions: 60,
    lines: 60
  }
}
```

---

## é˜¶æ®µäºŒï¼šæµ‹è¯•è¦†ç›–æ‰©å±• (P0-P1)

### 2.1 Renderer å±‚æµ‹è¯•æ‹†åˆ†

å°† `renderer.js` ä¸­å¯æµ‹é€»è¾‘æå–åˆ°ç‹¬ç«‹æ¨¡å—ï¼š

```
renderer/
â”œâ”€â”€ renderer.js      # ä¸»å…¥å£ï¼ˆDOM äº¤äº’ï¼‰
â”œâ”€â”€ utils.js         # å·¥å…·å‡½æ•°ï¼ˆå·²æœ‰æµ‹è¯•ï¼‰
â”œâ”€â”€ chatStore.js     # èŠå¤©çŠ¶æ€ç®¡ç† â† æ–°å¢
â”œâ”€â”€ sessionManager.js # ä¼šè¯ç®¡ç† â† æ–°å¢
â””â”€â”€ uiHelpers.js     # UI æ“ä½œé€»è¾‘ â† æ–°å¢
```

ä¸ºæ¯ä¸ªæ–°æ¨¡å—æ·»åŠ å¯¹åº”æµ‹è¯•ï¼š

- `tests/unit/chatStore.test.js`
- `tests/unit/sessionManager.test.js`
- `tests/unit/uiHelpers.test.js`

### 2.2 Preload å±‚æµ‹è¯•

åˆ›å»º `tests/unit/preload.test.js`ï¼š

- æµ‹è¯• `sendMessage` çš„è¯·æ±‚æ„é€ 
- æµ‹è¯• `abortRequest` çš„å–æ¶ˆé€»è¾‘
- æµ‹è¯•è¶…æ—¶å¤„ç†

### 2.3 Server é›†æˆæµ‹è¯•

åˆ›å»º `tests/integration/server-real.test.js`ï¼š

- ä½¿ç”¨çœŸå® Claude SDKï¼ˆéœ€ API Keyï¼‰
- æµ‹è¯•å®Œæ•´çš„ SSE æµç¨‹
- æ ‡è®°ä¸º CI å¯é€‰ï¼ˆæ—  Key æ—¶ skipï¼‰

---

## é˜¶æ®µä¸‰ï¼šæ–°åŠŸèƒ½é˜²æŠ¤ (P1)

### 3.1 ç³»ç»Ÿè®¾ç½®æµ‹è¯•è§„åˆ’

```
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ settings.test.js      # é…ç½®è¯»å†™é€»è¾‘
â”œâ”€â”€ e2e/
â”‚   â””â”€â”€ settings-flow.spec.js # è®¾ç½®ç•Œé¢æ“ä½œ
```

æ ¸å¿ƒæµ‹è¯•åœºæ™¯ï¼š

- ä¸»é¢˜åˆ‡æ¢æŒä¹…åŒ–
- è¯­è¨€è®¾ç½®åˆ‡æ¢
- API Key å®‰å…¨å­˜å‚¨
- è®¾ç½®å¯¼å…¥/å¯¼å‡º

### 3.2 æ²™ç®±åŠŸèƒ½æµ‹è¯•è§„åˆ’

```
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ sandbox.test.js       # æ²™ç®±æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ security/
â”‚   â””â”€â”€ sandbox-boundary.test.js # å®‰å…¨è¾¹ç•Œæµ‹è¯•
```

æ ¸å¿ƒæµ‹è¯•åœºæ™¯ï¼š

- æ–‡ä»¶ç³»ç»Ÿéš”ç¦»éªŒè¯
- ç½‘ç»œè®¿é—®é™åˆ¶éªŒè¯
- è¿›ç¨‹æƒé™è¾¹ç•Œæµ‹è¯•
- èµ„æºä½¿ç”¨é™åˆ¶æµ‹è¯•

---

## é˜¶æ®µå››ï¼šé«˜çº§é˜²æŠ¤ (P2)

### 4.1 å¥‘çº¦æµ‹è¯•

ä½¿ç”¨ JSON Schema å®šä¹‰ API å¥‘çº¦ï¼š

```
contracts/
â”œâ”€â”€ api-chat-request.schema.json
â”œâ”€â”€ api-chat-response.schema.json
â””â”€â”€ sse-events.schema.json
```

åœ¨æµ‹è¯•ä¸­éªŒè¯è¯·æ±‚/å“åº”ç¬¦åˆå¥‘çº¦ã€‚

### 4.2 è§†è§‰å›å½’æµ‹è¯•

Playwright å·²å¯ç”¨æˆªå›¾ (`screenshot: 'on'`)ï¼Œå¢åŠ ï¼š

- å…³é”®é¡µé¢å¿«ç…§å¯¹æ¯”
- è·¨æµè§ˆå™¨æ¸²æŸ“ä¸€è‡´æ€§æ£€æŸ¥

### 4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•

åˆ›å»º `tests/perf/baseline.test.js`ï¼š

- å¯åŠ¨æ—¶é—´åŸºå‡†
- æ¶ˆæ¯å‘é€å“åº”æ—¶é—´
- å†…å­˜ä½¿ç”¨ç›‘æ§

---

## ç›®å½•ç»“æ„æ¼”è¿›

```
tests/
â”œâ”€â”€ unit/                    # Vitest å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ utils.test.js       # å·²æœ‰
â”‚   â”œâ”€â”€ chatStore.test.js   # æ–°å¢
â”‚   â”œâ”€â”€ sessionManager.test.js # æ–°å¢
â”‚   â”œâ”€â”€ settings.test.js    # æ–°å¢
â”‚   â””â”€â”€ sandbox.test.js     # æ–°å¢
â”œâ”€â”€ api/                     # API æµ‹è¯•
â”‚   â””â”€â”€ server.test.js      # å·²æœ‰
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ server-real.test.js # æ–°å¢
â”œâ”€â”€ e2e/                     # Playwright E2E
â”‚   â”œâ”€â”€ app-launch.spec.js  # å·²æœ‰
â”‚   â”œâ”€â”€ chat-flow.spec.js   # å·²æœ‰
â”‚   â”œâ”€â”€ settings-flow.spec.js # æ–°å¢
â”‚   â””â”€â”€ sandbox-flow.spec.js # æ–°å¢
â”œâ”€â”€ security/                # å®‰å…¨æµ‹è¯•
â”‚   â””â”€â”€ sandbox-boundary.test.js # æ–°å¢
â””â”€â”€ perf/                    # æ€§èƒ½æµ‹è¯•
    â””â”€â”€ baseline.test.js    # æ–°å¢
```

---

## æ‰§è¡Œä¼˜å…ˆçº§

1. **âœ… å·²å®Œæˆ (Week 1)**ï¼šè¦†ç›–ç‡é—¨æ§› + ESLint + Prettier + Husky
2. **âœ… å·²å®Œæˆ**ï¼šç³»ç»Ÿè®¾ç½®æµ‹è¯•è„šæ‰‹æ¶ + preload.js å•å…ƒæµ‹è¯•
3. **âœ… å·²å®Œæˆ**ï¼šAPI å¥‘çº¦ JSON Schema
4. **âš ï¸ å¾…å®Œæˆ**ï¼šRenderer å±‚æ‹†åˆ† + å¯¹åº”æµ‹è¯•ï¼ˆå»ºè®®ä½¿ç”¨ Opusï¼‰
5. **âš ï¸ å¾…å®Œæˆ**ï¼šæ²™ç®±åŠŸèƒ½å®‰å…¨æµ‹è¯•ï¼ˆå»ºè®®ä½¿ç”¨ Opusï¼‰
6. **ğŸ“‹ å¯é€‰**ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•

---

## å…³é”®åº¦é‡ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | çŠ¶æ€ |

|------|--------|--------|------|

| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | 85.71% | 60% | âœ… å·²è¾¾æ ‡ |

| E2E åœºæ™¯æ•° | 35+ | 50+ | ğŸŸ¡ è¿›è¡Œä¸­ |

| ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ç‡ | 100% (0é”™è¯¯) | 95%+ | âœ… å·²è¾¾æ ‡ |

| æµ‹è¯•ç”¨ä¾‹æ€»æ•° | 96 | 100+ | ğŸŸ¡ æ¥è¿‘ç›®æ ‡ |

---

## å®Œæˆæƒ…å†µæ€»ç»“

### âœ… å·²å®Œæˆä»»åŠ¡ï¼ˆ5/7ï¼‰

1. **ESLint + Prettier + Husky** âœ…
   - é…ç½®æ–‡ä»¶å·²åˆ›å»º
   - Pre-commit hook å·²é…ç½®
   - ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ï¼ˆ0 é”™è¯¯ï¼‰

2. **è¦†ç›–ç‡é˜ˆå€¼é…ç½®** âœ…
   - Vitest è¦†ç›–ç‡é˜ˆå€¼å·²è®¾ç½®
   - å®é™…è¦†ç›–ç‡ 85.71%ï¼Œè¶…è¿‡ 60% é˜ˆå€¼
   - @vitest/coverage-v8 å·²å®‰è£…

3. **API å¥‘çº¦ JSON Schema** âœ…
   - `contracts/api-chat-request.schema.json` å·²åˆ›å»º
   - `contracts/sse-events.schema.json` å·²åˆ›å»º
   - ä½¿ç”¨æ–‡æ¡£å·²ç¼–å†™

4. **ç³»ç»Ÿè®¾ç½®æµ‹è¯•è„šæ‰‹æ¶** âœ…
   - `tests/unit/settings.test.js` - 14 ä¸ªæµ‹è¯•ç”¨ä¾‹
   - `tests/e2e/settings-flow.spec.js` - 7 ä¸ª E2E åœºæ™¯

5. **preload.js å•å…ƒæµ‹è¯•** âœ…
   - `tests/unit/preload.test.js` - 16 ä¸ªæµ‹è¯•ç”¨ä¾‹
   - è¦†ç›–è¯·æ±‚ç®¡ç†ã€è¶…æ—¶ã€é”™è¯¯å¤„ç†ç­‰

### âš ï¸ å¾…å®Œæˆä»»åŠ¡ï¼ˆ2/7ï¼‰

1. **renderer.js é‡æ„** - é«˜éš¾åº¦ï¼Œå»ºè®®ä½¿ç”¨ Opus
   - éœ€è¦å°† 1459 è¡Œä»£ç æ‹†åˆ†ä¸ºå¯æµ‹è¯•æ¨¡å—
   - æ¶‰åŠæ¶æ„é‡è®¾è®¡

2. **æ²™ç®±åŠŸèƒ½å®‰å…¨æµ‹è¯•** - é«˜éš¾åº¦ï¼Œå»ºè®®ä½¿ç”¨ Opus
   - éœ€è¦æ·±åº¦å®‰å…¨è®¾è®¡
   - æ¶‰åŠæ–‡ä»¶ç³»ç»Ÿéš”ç¦»ã€è¿›ç¨‹æƒé™ç­‰

### ğŸ“Š æˆæœç»Ÿè®¡

- **æ–°å¢æµ‹è¯•æ–‡ä»¶**: 3 ä¸ª
- **æ–°å¢æµ‹è¯•ç”¨ä¾‹**: 37+ ä¸ª
- **ä»£ç è¦†ç›–ç‡**: 85.71%ï¼ˆè¶…è¿‡é˜ˆå€¼ 25%+ï¼‰
- **ESLint é”™è¯¯**: 0 ä¸ª
- **Git æäº¤**: å·²å®Œæˆï¼ˆcommit: 1d4e54dï¼‰

### ğŸ“ ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•é˜²æŠ¤ç½‘å®æ–½æ€»ç»“](../docs/æµ‹è¯•é˜²æŠ¤ç½‘å®æ–½æ€»ç»“.md)
- [è‡ªåŠ¨åŒ–é˜²æŠ¤ç½‘éªŒè¯æŠ¥å‘Š](../docs/è‡ªåŠ¨åŒ–é˜²æŠ¤ç½‘éªŒè¯æŠ¥å‘Š.md)
