# Token 消耗优化分析报告

## 问题分析

### 主要 Token 消耗来源

1. **Plan 文件（最大消耗源）**
   - `.cursor/plans/` 目录：17 个文件，约 184KB
   - `docs/plans/` 目录：9 个文件，约 136KB
   - 总计：**超过 12,000 行**的文档内容
   - 最大文件：`2025-01-17-personalization.md` (1201行)

2. **测试文件**
   - `tests/` 目录：约 428KB
   - 大型测试文件：
     - `renderer.test.js` (1009行)
     - `chatManager.test.js` (940行)
     - `streamHandler.test.js` (921行)
     - `settings-module.test.js` (776行)

3. **原型文件**
   - `ux-prototype/` 目录：约 220KB
   - 大型 HTML 文件：
     - `upgraded-prototype.html` (1532行)
     - `prototype.html` (1490行)
     - `index.html` (1459行)

4. **大型代码文件**
   - `renderer/style.css` (3932行)
   - `renderer/renderer.js` (721行)

5. **媒体文件**
   - `open-claude-cowork.gif` (大文件)
   - `screenshots/` 目录下的图片文件

## 优化措施

### 已实施的优化

已更新 `.cursorindexingignore` 文件，排除以下内容：

1. ✅ **Plan 文件** - `.cursor/plans/**` 和 `docs/plans/**`
   - 这些文件通常只在需要查看特定计划时才需要
   - 可以通过 `@文件名` 显式引用

2. ✅ **测试文件** - `tests/**`
   - 测试文件在开发时可以通过 `@文件名` 显式引用
   - 日常对话不需要自动索引

3. ✅ **原型文件** - `ux-prototype/**`
   - 原型文件已完成历史使命，不需要在每次对话中加载

4. ✅ **媒体文件** - `*.gif`, `*.png`, `*.jpg` 等
   - 图片和视频文件不包含代码信息，不需要索引

5. ✅ **构建产物** - `playwright-report/**`, `test-results/**`, `screenshots/**`
   - 这些是运行时生成的临时文件

6. ✅ **大型文档文件** - 特定的大型文档文件
   - 这些文件很少需要在对话上下文中

### 预期效果

- **减少索引文件数量**：从 ~50+ 个文件减少到 ~20-30 个核心文件
- **减少 token 消耗**：预计减少 **60-70%** 的初始上下文 token
- **保留核心代码**：核心业务代码（`renderer/`, `server/`, `main.js` 等）仍然会被索引
- **灵活访问**：被排除的文件仍可通过 `@文件名` 显式引用

## 使用建议

### 如何访问被排除的文件

如果需要访问被排除的文件，可以使用以下方式：

1. **显式引用**：在对话中使用 `@文件名` 来引用特定文件
   - 例如：`@docs/plans/2025-01-17-ux-upgrade-master.md`

2. **临时取消排除**：如果需要频繁访问某个目录，可以临时修改 `.cursorindexingignore`

### 进一步优化建议

如果 token 消耗仍然较高，可以考虑：

1. **排除系统提示文件（可选）**
   - `cowork-prompt.md` 和 `cowork-prompt-zh.md` (各 428行，共 856行)
   - 这些是系统提示文件，通常不需要在每次对话上下文中
   - **注意**：如果这些文件对项目理解很重要，建议保留

2. **排除大型 CSS 文件（可选）**
   - `renderer/style.css` (3932行)
   - 如果主要关注逻辑而非样式，可以排除
   - **注意**：如果经常需要修改样式，建议保留

3. **使用 `.cursorrules` 文件**
   - 将项目规范提取到 `.cursorrules` 文件中
   - Cursor 会自动读取但不会占用对话上下文
   - 可以将 `CLAUDE.md` 的核心内容提取到 `.cursorrules`

4. **按需排除其他文档**
   - `README.md` (264行) - 如果不需要频繁查看，可以排除
   - `CLAUDE.md` (237行) - 如果已提取到 `.cursorrules`，可以排除

## 验证方法

1. **检查索引状态**：在 Cursor 中查看文件是否被正确排除
2. **测试新对话**：开始新对话，观察初始 token 消耗
3. **验证功能**：确保核心代码文件仍然可以被正常索引和访问

## 注意事项

- 被排除的文件**不会**自动出现在对话上下文中
- 如果需要某个被排除的文件，必须**显式引用**（使用 `@文件名`）
- 如果发现某些重要文件被误排除，可以随时修改 `.cursorindexingignore`
